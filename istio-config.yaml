apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: istio-spiffe
  namespace: istio-system
spec:
  profile: default

  meshConfig:
    # Trust domain must match Teleport cluster domain
    trustDomain: ellinj.teleport.sh

    # Path normalization configuration
    # Starting with NONE to prevent any normalization that might add trailing slashes
    pathNormalization:
      normalization: NONE

    # Default configuration for certificate provider
    defaultConfig:
      # This will be overridden per-pod with annotations
      proxyMetadata: {}

  components:
    pilot:
      k8s:
        env:
          # Enable SPIFFE integration features
          - name: PILOT_SKIP_VALIDATE_TRUST_DOMAIN
            value: "false"
          - name: PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION
            value: "true"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi

  values:
    global:
      # Logging level for debugging
      logging:
        level: "default:info"

    # Sidecar injector configuration
    sidecarInjectorWebhook:
      templates:
        # SPIFFE CSI Driver integration template
        spire: |
          labels:
            spiffe.io/spire-managed-identity: "true"
          spec:
            volumes:
            - name: workload-socket
              csi:
                driver: "csi.spiffe.io"
                readOnly: true
            containers:
            - name: istio-proxy
              volumeMounts:
              - name: workload-socket
                mountPath: /run/secrets/workload-spiffe-uds
                readOnly: true
              env:
              - name: CA_ADDR
                value: unix:///run/secrets/workload-spiffe-uds/socket
              - name: PILOT_CERT_PROVIDER
                value: "workloadapi"
