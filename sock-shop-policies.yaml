# Istio Authorization Policies using SPIFFE IDs from Teleport
# These policies demonstrate service-to-service authorization based on workload identities
---
# Default deny-all policy for sock-shop namespace
# This ensures only explicitly allowed traffic is permitted
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: sock-shop
spec:
  {}  # Empty spec means deny all
---
# Allow front-end to call catalogue service
# Uses SPIFFE ID to verify the calling service identity
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: catalogue-allow-frontend
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: catalogue
  action: ALLOW
  rules:
  - from:
    - source:
        # SPIFFE ID format: <trust-domain>/ns/<namespace>/sa/<service-account>
        # Note: Istio automatically adds the spiffe:// prefix
        principals:
        - "ellinj.teleport.sh/ns/sock-shop/sa/front-end"
    to:
    - operation:
        methods: ["GET"]
        paths: ["/catalogue*", "/tags", "/health"]
---
# Allow catalogue to call catalogue-db
# Database access should only come from catalogue service
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: catalogue-db-allow-catalogue
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: catalogue-db
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "ellinj.teleport.sh/ns/sock-shop/sa/catalogue"
    to:
    - operation:
        ports: ["3306"]
---
# Allow carts service to call carts-db (MongoDB)
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: carts-db-allow-carts
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: carts-db
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "ellinj.teleport.sh/ns/sock-shop/sa/carts"
    to:
    - operation:
        ports: ["27017"]
---
# Allow front-end to call carts service
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: carts-allow-frontend
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: carts
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "ellinj.teleport.sh/ns/sock-shop/sa/front-end"
    to:
    - operation:
        methods: ["GET", "POST", "DELETE"]
        paths: ["/*"]
---
# Allow front-end to call orders service
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: orders-allow-frontend
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: orders
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "ellinj.teleport.sh/ns/sock-shop/sa/front-end"
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/orders*"]
---
# Allow external access to front-end
# This permits ingress gateway or direct LoadBalancer access
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: frontend-allow-external
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: front-end
  action: ALLOW
  rules:
  - from:
    - source:
        # Allow from istio-ingressgateway
        namespaces: ["istio-system"]
  - {} # Also allow direct access (for LoadBalancer service)
---
# Enable strict mTLS for the entire namespace
# This ensures all communication uses Teleport-issued certificates
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: default
  namespace: sock-shop
spec:
  mtls:
    mode: STRICT
---
# Allow MySQL protocol for catalogue-db
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: catalogue-db-permissive
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: catalogue-db
  mtls:
    mode: STRICT  # Enforce mTLS
---
# MongoDB protocol for carts-db
# Workload-specific policy needed for proper mTLS negotiation
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: carts-db-mtls
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: carts-db
  mtls:
    mode: STRICT
---
# Allow direct access to front-end without mTLS
# This permits external LoadBalancer access without certificates
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: frontend-permissive
  namespace: sock-shop
spec:
  selector:
    matchLabels:
      app: front-end
  mtls:
    mode: PERMISSIVE  # Allows both mTLS and plaintext
---
# Enforce client mTLS policy for catalogue-db
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: catalogue-db
  namespace: sock-shop
spec:
  host: catalogue-db.sock-shop.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
---
# Enforce client mTLS policy for carts-db (MongoDB)
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: carts-db
  namespace: sock-shop
spec:
  host: carts-db.sock-shop.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
